# Трекер задач LytSlot Pro

Отслеживание прогресса разработки. Задачи сгруппированы по разделам Project.md. При выполнении обновляйте статус. Новые задачи добавляйте в соответствующие разделы с приоритетом: **Критический** | **Высокий** | **Средний** | **Низкий**.

**Статусы**: `Не начата` | `В процессе` | `Завершена` | `Отложена`

---

## Формат задачи

```markdown
- **[Название]** | Приоритет: Критический/Высокий/Средний/Низкий | Статус: ...
  - Описание: ...
  - Шаги: [ ] шаг 1; [x] шаг 2
  - Зависимости: ...
```

---

## 1. Инфраструктура и основа

- **Репозиторий и структура проекта (backend, bot, frontend, docs)** | Приоритет: Критический | Статус: Завершена
  - Описание: Монорепо; папки services/api, bot, worker, web; infra; db; shared; tests; docs.
  - Шаги: [x] Выбор структуры; [x] Инициализация папок и файлов; [x] README и .gitignore
  - Зависимости: Нет

- **Docker-окружение для локальной разработки** | Приоритет: Критический | Статус: Завершена
  - Описание: docker-compose: TimescaleDB (PostgreSQL 16), Redis; образы api, bot, worker, web.
  - Шаги: [x] docker-compose.yml; [x] .env.example; [x] Dockerfile'ы в infra/; [x] README
  - Зависимости: Структура проекта

- **CI/CD (GitHub Actions)** | Приоритет: Высокий | Статус: В процессе
  - Описание: Сборка, тесты, линтеры; деплой на staging/production (Render/AWS/DO).
  - Шаги: [x] Workflow backend (ruff, black, pytest с PostgreSQL); [x] Workflow frontend (lint, build); [ ] Деплой по ветке/тегу (при необходимости)
  - Зависимости: Репозиторий, окружение

---

## 1.1 Архитектурные доработки (пост-ревью)

Детальный план: **docs/Architecture-Plan.md**. Выполнять после первого пуша на GitHub.

- **Один источник сессии БД в API** | Приоритет: Высокий | Статус: Завершена
  - Описание: Убрать дублирование get_db; оставить только deps.get_db / get_db_with_required_tenant; в db.database — только SessionLocal.
  - Шаги: [x] Удалить get_db из db.database; [x] Проверить импорты в services/api; [x] Скрипты/seed не используют db.database.get_db
  - Зависимости: Нет

- **Опциональный Worker (Celery)** | Приоритет: Высокий | Статус: Завершена
  - Описание: Не вызывать Celery при пустом broker; логировать «worker disabled»; в dev работать без Redis/Celery без тихих сбоев.
  - Шаги: [x] Конфиг CELERY_BROKER_URL; [x] В orders.py проверять перед .delay(); [x] Документировать в README и .env.example
  - Зависимости: Нет

- **Админ: роль и сессия без RLS** | Приоритет: Критический | Статус: Завершена
  - Описание: Список ADMIN_TELEGRAM_IDS в конфиге; get_current_admin_user_id; get_db_admin с отключением RLS только для админ-роутов; admin.py переведён.
  - Шаги: [x] Конфиг ADMIN_TELEGRAM_IDS; [x] auth: get_current_admin_user_id; [x] deps: get_db_admin (SET LOCAL row_level_security = off); [x] admin.py использовать get_db_admin и get_current_admin_user_id; [x] Зафиксировано в docs
  - Зависимости: Нет

---

## 2. Backend (FastAPI)

- **Модели данных и миграции (SQLAlchemy, tenant_id)** | Приоритет: Критический | Статус: Завершена
  - Описание: Tenant, Channel, Slot, Order, Payment, View (hypertable); RLS по app.tenant_id; Alembic 001 + seed.
  - Шаги: [x] Модели; [x] RLS; [x] Миграция 001 + TimescaleDB hypertable; [x] db/seed.py
  - Зависимости: Docker с PostgreSQL

- **Auth: Telegram Login + JWT** | Приоритет: Критический | Статус: Завершена
  - Описание: Валидация Telegram Login Widget, выдача JWT; refresh token при необходимости.
  - Шаги: [x] Эндпоинт POST /api/auth/callback; [x] Верификация initData через BOT_TOKEN (HMAC-SHA256); [x] get_or_create Tenant по telegram_id; [x] JWT с sub (telegram_id) и tenant_id; [x] Зависимости get_current_user_id, get_optional_tenant_id, get_current_tenant_id; [x] get_db_with_required_tenant для RLS
  - Зависимости: Модели пользователя (Tenant)

- **API: каналы, слоты, заказы (CRUD + бизнес-логика)** | Приоритет: Критический | Статус: Завершена
  - Описание: REST для каналов (добавление, настройка), слотов (шаг 15/30/60, цены), заказов (создание, статусы).
  - Шаги: [x] Каналы: GET list, GET /{id}, POST create, PATCH /{id}; [x] Слоты: GET list (channel_id, date_from/date_to), GET /{id}, POST create; [x] Заказы: GET list, GET /{id}, POST create, PATCH /{id} (status); [x] Привязка к tenant через get_db_with_required_tenant
  - Зависимости: Auth, модели

- **WebSockets для дашборда (реал-тайм обновления)** | Приоритет: Средний | Статус: Не начата
  - Описание: Подписка на события заказов/слотов для веб-кабинета.
  - Шаги: [ ] Подключение по JWT; [ ] Комнаты по tenant; [ ] События от Celery/API
  - Зависимости: API заказов/слотов

- **Rate limiting (100 req/min/user)** | Приоритет: Высокий | Статус: Завершена
  - Описание: В API по user_id (JWT sub) или по IP; Redis, окно 60 сек, лимит из settings.rate_limit_per_minute.
  - Шаги: [x] RateLimitMiddleware с ключом из JWT (get_user_id_from_token_or_none) или IP; [x] Подключение в main.py; [x] Конфиг rate_limit_per_minute (env), заголовок Retry-After при 429
  - Зависимости: Auth

- **request_id и структурированные логи (observability)** | Приоритет: Высокий | Статус: Завершена
  - Описание: Сквозной X-Request-Id в API и Celery; логи в JSON (structlog) с полями request_id, tenant_id, уровень, время.
  - Шаги: [x] RequestIdMiddleware; [x] logging_config (contextvars, structlog JSON); [x] передача request_id в задачи Celery; [x] воркер логирует с request_id
  - Зависимости: Нет

- **Readiness probe** | Приоритет: Высокий | Статус: Завершена
  - Описание: GET /ready — проверка БД и при CELERY_BROKER_URL — Redis; 503 при недоступности зависимостей.
  - Шаги: [x] Эндпоинт /ready в main.py; [x] использование в деплое (документация в Diary)
  - Зависимости: Нет

- **Интеграционные тесты (заказ, RLS)** | Приоритет: Высокий | Статус: Завершена
  - Описание: Тесты создания заказа, списка заказов, изоляции по тенантам (RLS).
  - Шаги: [x] tests/conftest.py (client, tenants, JWT); [x] test_orders.py; [x] test_rls.py; [x] test_health.py
  - Зависимости: PostgreSQL, ENABLE_DEV_LOGIN

---

## 3. Очереди и воркеры (Celery + Redis)

- **Подключение Celery к Redis и базовые таски** | Приоритет: Критический | Статус: Завершена
  - Описание: Celery app, очереди (publish, notifications, analytics); пример таска.
  - Шаги: [x] Конфиг Celery (REDIS_URL, task_routes, default queue); [x] Запуск: celery -A services.worker.celery_app worker -Q default,publish,notifications,analytics; [x] Таск ping; [x] Скрипт scripts/run-worker.sh
  - Зависимости: Docker Redis, Backend

- **Таск публикации поста в канал** | Приоритет: Критический | Статус: Завершена
  - Описание: По заказу: загрузка медиа, отправка в Telegram от имени канала (бот админ).
  - Шаги: [x] Таск publish_order (RLS через set_config tenant_id, запись в views); [x] Вызов publish_order.delay при создании заказа в API; [x] Реальная отправка в Telegram (Bot API sendMessage, chat_id=@channel.username, BOT_TOKEN в env воркера); [x] После успешной отправки — статус заказа PUBLISHED
  - Зависимости: Бот (права в каналах), модели заказа

- **Уведомления (клиенту/рекламодателю)** | Приоритет: Высокий | Статус: Завершена
  - Описание: Telegram-уведомления о новом заказе, оплате, отмене.
  - Шаги: [x] Таск send_notification(telegram_id, text); [x] notify_new_order, notify_order_cancelled, notify_payment_received с шаблонами; [x] Вызов notify_new_order при создании заказа, notify_order_cancelled при PATCH статуса на cancelled
  - Зависимости: Бот, модели

---

## 4. Telegram-бот (aiogram 3.x)

- **Базовый бот: старт, FSM «Мои каналы → Слот → Заказ»** | Приоритет: Критический | Статус: Завершена
  - Описание: Один бот @LytSlotProBot; после авторизации — список каналов пользователя, выбор слота, оформление заказа.
  - Шаги: [x] Проект aiogram 3; [x] FSM сценарий (OrderStates: channel → slot → content → confirm); [x] Вызов API backend для данных и создания заказа
  - Зависимости: Backend API, Auth

- **Интеграция с API (получение каналов, слотов, создание заказа)** | Приоритет: Критический | Статус: Завершена
  - Описание: Бот как клиент FastAPI; токен пользователя (Telegram ID → JWT через dev-login для разработки).
  - Шаги: [x] get_token(telegram_id), get_channels, get_slots, create_order в api_client; [x] Маппинг в клавиатуры (каналы, слоты), создание заказа по подтверждению
  - Зависимости: Backend API

- **Multi-bot sharding (dispatcher groups)** | Приоритет: Высокий | Статус: Не начата
  - Описание: При росте нагрузки — несколько инстансов бота с шардингом по обновлениям.
  - Шаги: [ ] Конфиг sharding; [ ] Деплой нескольких воркеров
  - Зависимости: Базовый бот стабилен

---

## 5. Frontend (Next.js 14)

- **Дизайн-система и прототип портала (премиум UX/UI)** | Приоритет: Критический | Статус: Завершена
  - Описание: Единый визуальный стиль: токены (globals.css), Tailwind (акцент emerald, тени, шрифт Plus Jakarta Sans), компоненты Card/Button, оболочка дашборда (DashboardShell), лендинг и дашборд-обзор.
  - Шаги: [x] Токены и расширение Tailwind; [x] Шрифт next/font; [x] Card, Button, ButtonLink; [x] DashboardShell (сайдбар, навигация); [x] Лендинг (hero, возможности, CTA); [x] Страница «Обзор» дашборда (метрики, каналы из API, плейсхолдер календаря)
  - Зависимости: Нет. Дальнейшие страницы (Каналы, Заказы, Календарь, Аналитика) строятся на этой основе.

- **Инициализация Next.js 14 (App Router), Tailwind** | Приоритет: Критический | Статус: Завершена
  - Описание: Проект, стили, базовая структура; дизайн-система реализована без shadcn (собственные компоненты).
  - Шаги: [x] Next.js App Router; [x] Tailwind + дизайн-система; [x] Лендинг и оболочка дашборда
  - Зависимости: Нет

- **Auth (Telegram Login + JWT на фронте)** | Приоритет: Критический | Статус: Завершена
  - Описание: Вход через Telegram, сохранение JWT (localStorage), защита маршрутов дашборда.
  - Шаги: [x] Страница /login с Telegram Login Widget; [x] /login/callback — POST initData → API, сохранение token, редирект в дашборд; [x] Guard в app/dashboard/layout.tsx (редирект на /login при отсутствии token); [x] Выход — очистка token и редирект на /
  - Зависимости: Backend Auth (готов)

- **Дашборд: мои каналы, слоты, заказы** | Приоритет: Критический | Статус: Завершена
  - Описание: Список каналов, настройка слотов (шаг, цены), список заказов; TanStack Query к API; единый стиль (DashboardShell + Card/Button).
  - Шаги: [x] Layout и обзор; [x] Страница «Каналы» (список, добавление, редактирование PATCH); [x] Страница «Заказы» (список, превью контента, смена статуса PATCH); [x] Страница «Календарь» (слоты по каналу, создание слота); [x] Создание заказа из слота (форма: текст, ссылка)
  - Зависимости: API, Auth frontend (готов)

- **Календарь слотов (FullCalendar)** | Приоритет: Высокий | Статус: Завершена
  - Описание: Визуализация слотов по дням/неделям, бронирование; в том же стиле (DashboardShell, Card).
  - Шаги: [x] Интеграция FullCalendar (core, daygrid, timegrid, interaction); [x] События из API (слоты → события, свободен/занят); [x] Клик по свободному слоту — форма создания заказа
  - Зависимости: Дашборд, API слотов

- **Аналитика: views, CTR, revenue (Recharts)** | Приоритет: Высокий | Статус: Завершена
  - Описание: Графики по каналам/периодам; данные из API (TimescaleDB/агрегаты); страница в разделе «Аналитика» дашборда.
  - Шаги: [x] Эндпоинты аналитики (GET /api/analytics/summary, GET /api/analytics/views); [x] Страница отчётов (сводка, график просмотров по дням, фильтр по каналу и периоду, Recharts)
  - Зависимости: Backend аналитика, дашборд

- **API-ключи в кабинете** | Приоритет: Средний | Статус: Завершена
  - Описание: Генерация/отзыв API-ключей для партнёров/интеграций.
  - Шаги: [x] Backend: модель ApiKey (tenant_id, key_hash, name), миграция 003, RLS; [x] Эндпоинты GET/POST/DELETE /api/api-keys; [x] UI в Настройках: список, создание (имя опционально), показ ключа один раз, отзыв
  - Зависимости: Auth, дашборд

---

## 6. Платежи

- **Интеграция ЮKassa (создание платежа, webhook)** | Приоритет: Критический | Статус: Не начата
  - Описание: Оплата заказа/подписки; webhook для смены статуса; зачисление на баланс tenant.
  - Шаги: [ ] Модель платежа; [ ] Эндпоинт создания; [ ] Webhook и обновление заказа
  - Зависимости: Модели заказа/подписки

- **Интеграция Stripe (international)** | Приоритет: Высокий | Статус: Не начата
  - Описание: Аналогично ЮKassa для международных плательщиков.
  - Шаги: [ ] Stripe Checkout/Session; [ ] Webhook; [ ] Единая модель платежа
  - Зависимости: Платежи ЮKassa

- **Payouts владельцам каналов (revenue share 20%)** | Приоритет: Высокий | Статус: Не начата
  - Описание: Расчёт доли, вывод на реквизиты (ЮKassa/Stripe Connect или ручной вывод).
  - Шаги: [ ] Модель выплат; [ ] Расчёт 80/20; [ ] Эндпоинты/админка для выплат
  - Зависимости: Платежи, модель revenue

---

## 7. Админ-панель

- **Супер-дашборд: все каналы, топ-клиенты, revenue** | Приоритет: Высокий | Статус: Не начата
  - Описание: Отдельный фронт или раздел; только для роли admin; агрегаты по платформе.
  - Шаги: [ ] Роль admin в backend; [ ] Эндпоинты агрегатов; [ ] UI дашборда
  - Зависимости: Auth с ролями, аналитика

- **Модерация контента и блокировка** | Приоритет: Высокий | Статус: Не начата
  - Описание: Просмотр заказов/креативов, блокировка канала/клиента, причина.
  - Шаги: [ ] Эндпоинты модерации; [ ] UI: список, действия, логи
  - Зависимости: Админ-дашборд

---

## 8. Продвинутые функции

- **A/B-тесты креативов** | Приоритет: Средний | Статус: Не начата
  - Описание: Варианты креатива по слоту, сбор метрик (CTR), выбор победителя.
  - Зависимости: Аналитика, слоты

- **Пакетные слоты** | Приоритет: Средний | Статус: Не начата
  - Описание: Несколько слотов одним заказом со скидкой.
  - Зависимости: Модель заказа, API заказов

- **Подписка Pro (10k₽/мес, 10 каналов)** | Приоритет: Высокий | Статус: Не начата
  - Описание: Тариф Pro, лимит каналов, списание по подписке (Stripe/ЮKassa).
  - Зависимости: Платежи, модель подписки

- **Белый список рекламодателей** | Приоритет: Низкий | Статус: Не начата
  - Описание: Разрешать заказы только от одобренных рекламодателей (по каналу/глобально).
  - Зависимости: Заказы, модерация

- **ККТУ/ERID в чеках и рекламе** | Приоритет: Высокий | Статус: Не начата
  - Описание: Соответствие законодательству РФ (чек, маркировка рекламы).
  - Зависимости: Платежи, заказы

---

## 9. Инфраструктура и мониторинг

- **Деплой на Render/AWS/DO (Docker/K8s)** | Приоритет: Высокий | Статус: Не начата
  - Описание: Окружения staging/production; масштабирование приложения и воркеров.
  - Зависимости: CI/CD, Docker

- **Prometheus + Grafana** | Приоритет: Высокий | Статус: Не начата
  - Описание: Метрики API, Celery, Redis, PostgreSQL; дашборды.
  - Зависимости: Деплой

- **Sentry (ошибки)** | Приоритет: Высокий | Статус: Не начата
  - Описание: Backend + Frontend; алерты.
  - Зависимости: Деплой

- **Cloudflare (WAF, DDoS, CDN)** | Приоритет: Высокий | Статус: Не начата
  - Описание: Домен через Cloudflare; WAF правила; CDN для статики/медиа.
  - Зависимости: Домен, деплой

- **TimescaleDB для аналитики views** | Приоритет: Средний | Статус: Не начата
  - Описание: Хранение событий просмотров по времени; агрегаты для дашборда.
  - Зависимости: Backend аналитика

- **AI-модерация контента (Gemini/Claude API)** | Приоритет: Низкий | Статус: Не начата
  - Описание: Проверка текста/медиа перед публикацией; флаг для ручной модерации.
  - Зависимости: Публикация поста, админка

---

## 10. Документация и качество

- **OpenAPI и описание API** | Приоритет: Высокий | Статус: Завершена
  - Описание: Актуальная спецификация FastAPI; экспорт в Redoc/Swagger.
  - Шаги: [x] Описание приложения, теги (channels, slots, orders, analytics, admin); [x] summary у эндпоинтов; [x] Swagger /docs, ReDoc /redoc; [x] Скрипт export-openapi.py → docs/openapi.json
  - Зависимости: Backend API

- **Линтеры и pre-commit (backend, frontend)** | Приоритет: Высокий | Статус: Завершена
  - Описание: ruff/black (Python), ESLint/Prettier (Next.js); pre-commit hooks.
  - Шаги: [x] ruff + black в pyproject.toml (dev); [x] Prettier в services/web, скрипты format/format:check; [x] .pre-commit-config.yaml (ruff, black, frontend eslint, frontend prettier); [x] README и docs
  - Зависимости: Структура проекта

Все новые задачи добавлять в соответствующий раздел с указанием приоритета и статуса.
