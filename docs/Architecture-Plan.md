# План архитектурных изменений (пост-ревью)

План выполняется **после** сохранения текущей ветки на GitHub. Основа: [архитектурное ревью](Diary.md) и принятое решение заложить границы tenant/admin и опциональный worker до разрастания кода.

---

## Цели

1. **Admin:** явная модель «админ» + сессия с обходом RLS только для админ-маршрутов; без этого админ-панель не видит данные или создаёт риски.
2. **Worker:** вызов Celery только при настроенном broker; в dev можно работать без Redis/Celery без тихих сбоев.
3. **Сессия БД:** один источник сессии в API (`deps.get_db`); убрать дублирование в `db.database`.

---

## Задача 1: Админ — роль и сессия без RLS

| Пункт | Действие |
|-------|----------|
| 1.1 | В конфиг (например `services/api/config.py`) добавить список админов: `admin_telegram_ids: list[int]` из env (например `ADMIN_TELEGRAM_IDS=123,456`) или один `admin_telegram_id` для MVP. |
| 1.2 | В `services/api/auth.py`: новая зависимость `get_current_admin_user_id` — проверяет JWT, извлекает `sub` (telegram_id), проверяет вхождение в `admin_telegram_ids`; иначе 403. |
| 1.3 | В `services/api/deps.py`: новая зависимость `get_db_admin` — возвращает сессию **без** `set_config('app.tenant_id', ...)`. Перед использованием сессии выполнить `SET LOCAL row_level_security = off` для текущей транзакции (или использовать роль с BYPASSRLS — сложнее). Проще: отдельное подключение/роль не делать, а в миграции добавить политику для админа (сложно без ролей в БД). **Рекомендуемый вариант:** в `get_db_admin` после получения сессии выполнить `db.execute(text("SET LOCAL row_level_security = off"))` — тогда все запросы в этом request увидят все строки. Риск: вызывать только из админ-эндпоинтов. |
| 1.4 | В `services/api/routers/admin.py`: заменить `get_db` на `get_db_admin`, `get_current_user_id` на `get_current_admin_user_id`. Убедиться, что эндпоинты возвращают данные. |
| 1.5 | В `docs/Project.md` или `docs/Diary.md` зафиксировать: админ = пользователь, чей telegram_id в списке ADMIN_TELEGRAM_IDS; админ-эндпоинты используют сессию с отключённым RLS. |

**Критерий готовности:** GET `/api/admin/channels` возвращает все каналы всех тенантов только при запросе с JWT пользователя из списка админов; иначе 403.

---

## Задача 2: Опциональный Worker (Celery)

| Пункт | Действие |
|-------|----------|
| 2.1 | В `services/api/config.py`: добавить `celery_broker_url: str = ""` (или использовать существующий REDIS_URL как broker). Если пусто — считать worker отключённым. |
| 2.2 | В `services/api/routers/orders.py` (и везде, где вызывается `*.delay()`): перед вызовом проверять `if settings.celery_broker_url:` (или хелпер `tasks_available()`); если нет — не вызывать `.delay()`, логировать `logger.info("Worker disabled; skipping task ...")`. Импорт модуля tasks оставить в try/except или условный — чтобы при отсутствии Celery приложение стартовало. |
| 2.3 | В `README` или `docs/`: указать, что при пустом broker API работает без фоновых задач (подходит для dev). |

**Критерий готовности:** При не заданном broker создание заказа не падает, в логе есть сообщение о пропуске задачи; при заданном broker задачи уходят в очередь как раньше.

---

## Задача 3: Один источник сессии БД в API

| Пункт | Действие |
|-------|----------|
| 3.1 | В `db/database.py`: удалить функцию `get_db()` (генератор с yield), оставить только `SessionLocal` и при необходимости явную фабрику для тестов. |
| 3.2 | Убедиться, что везде в `services/api` используется только `get_db` / `get_db_with_required_tenant` / `get_db_admin` из `services.api.deps`. Проверить импорты: в `main.py` и роутерах — только `from services.api.deps import get_db, ...`. |
| 3.3 | Если Alembic или скрипты (seed, миграции) используют `db.database.get_db` — перевести на прямое использование `SessionLocal()` (контекстный менеджер или with). |

**Критерий готовности:** В коде нет дублирующего определения сессии; все API-зависимости берутся из `deps`.

---

## Порядок выполнения

1. **Сначала** сохранить текущую ветку на GitHub (см. инструкцию ниже).
2. **Задача 3** (один источник сессии) — быстрая, без риска для бизнес-логики.
3. **Задача 2** (опциональный worker) — малый объём, снижает тихие сбои в dev.
4. **Задача 1** (админ) — самая важная для безопасности и работоспособности админ-панели; делать аккуратно и проверить RLS on/off.

После каждой задачи — коммит, при необходимости обновить `docs/Tasktracker.md` и `docs/Diary.md`.

---

## Статус (2025-02-20)

- **Задача 3** — выполнена: `get_db` удалён из `db.database.py`.
- **Задача 2** — выполнена: `CELERY_BROKER_URL`, условный вызов `.delay()` в `orders.py`.
- **Задача 1** — выполнена: `ADMIN_TELEGRAM_IDS`, `get_current_admin_user_id`, `get_db_admin`, админ-роуты переведены.
