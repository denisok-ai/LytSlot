# Инфраструктура LytSlot Pro

Docker-образы и compose для развёртывания.

---

## Автономные докеры: варианты и эффективность

Под «автономными докерами» имеется в виду развёртывание с минимумом ручных шагов: клонировал репозиторий → одна команда → приложение работает.

### Что уже есть

| Вариант | Команда | Что поднимается | Когда использовать |
|--------|---------|------------------|--------------------|
| **Минимальный стек** | `docker compose -f infra/docker-compose.yml up -d` | db, redis, api, web | Первый запуск, демо, проверка без бота и воркера. Не нужен BOT_TOKEN. |
| **Полный стек** | `docker compose -f infra/docker-compose.yml --profile full up -d` | + bot, worker | Продакшен: бот, фоновые задачи (публикация, уведомления). |
| **Скрипт (рекомендуется)** | `./scripts/docker-up-full.sh` | Полный стек + автосоздание .env при отсутствии + миграции и seed | Развёртывание на сервере одной командой после клонирования. |
| **Скрипт минимальный** | `./scripts/docker-up-full.sh --minimal` | Как минимальный стек + миграции и seed | Быстрый старт без бота/воркера. |

Скрипт при отсутствии `.env` копирует его из `.env.example`, так что «клонировать и запустить» возможно без предварительного ручного создания `.env` (для продакшена потом нужно задать JWT_SECRET и BOT_TOKEN).

### Насколько это эффективно

- **Плюсы автономного подхода**
  - Один раз настроил Docker/Podman — дальше одна команда (или два режима: минимальный/полный).
  - Меньше шагов → меньше ошибок при развёртывании.
  - Профили Compose: минимальный стек быстрее собирается и стартует (меньше контейнеров), полный — когда нужны бот и воркер.
  - `restart: unless-stopped` и healthchecks уже в compose — после перезагрузки сервера контейнеры поднимаются сами.

- **Ограничения**
  - Секреты (JWT_SECRET, BOT_TOKEN) не должны лежать в репозитории: их задают в `.env` на сервере (скрипт может создать `.env` из примера, но для прода — обязательно отредактировать).
  - Один `docker-compose` на одной машине: для масштабирования (несколько нод, K8s) нужны отдельные манифесты (см. `infra/k8s/`).

- **Итог:** для одного сервера и быстрого развёртывания текущая схема с автономными докерами эффективна: минимум действий, два режима (минимальный/полный), один скрипт с миграциями и автосозданием `.env`.

### Не делаем «один образ на всё»

Вариант «один Docker-образ с БД + Redis + API + бот + воркер + web внутри» (например, через supervisord) **не рекомендуется**:

- Сложнее масштабировать и обновлять по отдельности.
- Сложнее отлаживать и смотреть логи.
- Нарушается практика «один процесс на контейнер».

Текущее разбиение (отдельные сервисы + один compose) даёт удобство развёртывания и сохраняет нормальную эксплуатацию.

---

## Файлы

- **docker-compose.yml** — все сервисы; бот и воркер в профиле `full`.
- **Dockerfile.api**, **Dockerfile.bot**, **Dockerfile.worker** — образы backend.
- **services/web/Dockerfile** — образ Next.js (standalone).
- **registries.conf** — пример конфига для Podman (полные имена образов).

Подробные шаги развёртывания: [docs/Deploy-Clean-OS.md](../docs/Deploy-Clean-OS.md).
